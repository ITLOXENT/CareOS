name: terraform

on:
  pull_request:
    paths:
      - "infra/terraform/**"
  push:
    branches:
      - main
    paths:
      - "infra/terraform/**"
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (stage or prod)"
        required: true
        default: "stage"

jobs:
  plan:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infra/terraform/envs/dev
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
      - name: Terraform fmt
        run: terraform fmt -check -recursive
        working-directory: infra/terraform
      - name: Terraform init
        run: terraform init -backend=false
      - name: Terraform validate
        run: terraform validate
      - name: Terraform plan
        run: terraform plan -no-color

  apply:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
      - name: Terraform init
        run: terraform init
        working-directory: infra/terraform/envs/${{ inputs.environment }}
      - name: Terraform apply
        run: terraform apply -auto-approve
        working-directory: infra/terraform/envs/${{ inputs.environment }}
        env:
          TF_VAR_sentry_dsn: ${{ secrets.SENTRY_DSN }}
          TF_VAR_sentry_environment: ${{ inputs.environment }}
          TF_VAR_sentry_release: ${{ github.sha }}
          TF_VAR_sentry_traces_sample_rate: ${{ vars.SENTRY_TRACES_SAMPLE_RATE }}
          TF_VAR_sentry_send_default_pii: ${{ vars.SENTRY_SEND_DEFAULT_PII }}

  apply_stage:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: stage
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
      - name: Terraform init
        run: terraform init
        working-directory: infra/terraform/envs/stage
      - name: Terraform apply (stage)
        run: terraform apply -auto-approve
        working-directory: infra/terraform/envs/stage
        env:
          TF_VAR_sentry_dsn: ${{ secrets.SENTRY_DSN }}
          TF_VAR_sentry_environment: "stage"
          TF_VAR_sentry_release: ${{ github.sha }}
          TF_VAR_sentry_traces_sample_rate: ${{ vars.SENTRY_TRACES_SAMPLE_RATE }}
          TF_VAR_sentry_send_default_pii: ${{ vars.SENTRY_SEND_DEFAULT_PII }}
